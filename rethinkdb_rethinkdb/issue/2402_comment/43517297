IssueComment
  { issueCommentUpdatedAt = 2014 (-05) (-19) 15 : 17 : 41 UTC
  , issueCommentUser =
      SimpleUser
        { simpleUserId = Id 8194
        , simpleUserLogin = N "chrisguidry"
        , simpleUserAvatarUrl =
            "https://avatars.githubusercontent.com/u/8194?v=3"
        , simpleUserUrl = "https://api.github.com/users/chrisguidry"
        , simpleUserType = OwnerUser
        }
  , issueCommentUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/comments/43517297"
  , issueCommentHtmlUrl =
      "https://github.com/rethinkdb/rethinkdb/issues/2402#issuecomment-43517297"
  , issueCommentCreatedAt = 2014 (-05) (-19) 15 : 17 : 41 UTC
  , issueCommentBody =
      "We're seeing the same symptoms in both our production and test environments, and they definitely started the day we upgraded our RethinkDB servers from 1.11 to 1.12.4.  Prior to the upgrade, we had never experienced OOM issues.\r\n\r\nOur setup:\r\n2 nodes on AWS, m3.mediums (3.7Gb RAM)\r\nEBS volumes underlying /var/lib/rethinkdb\r\n\r\nInitially, we left our cache-size setting at the default.  A few days ago we dialed it down to 1024, but have still been seeing OOM crashes every 20 hours or so.  We decreased it to 128 this morning.  See the attached syslog file for an example.  The RethinkDB logs are completely quiet during this time, except that the other instance notes that it lost contact with the crashing one.\r\n\r\nOur read load is typically around 100/sec, write load 30/sec.\r\n\r\nAttached are a listing of our /var/lib/rethinkdb directories for the two instances.  You'll see our data is a little lumpy, with a dozen or so small tables, and a couple of large ones.  The large ones are acting sort of like 'fact' tables and take reads and writes frequently.\r\n\r\n\r\n\r\nSyslog example:\r\n<pre>\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292387] rs:main Q:Reg invoked oom-killer: gfp_mask=0x2000d0, order=0, oom_score_adj=0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292391] rs:main Q:Reg cpuset=/ mems_allowed=0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292394] CPU: 0 PID: 863 Comm: rs:main Q:Reg Not tainted 3.11.0-15-generic #23-Ubuntu\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292396]  0000000000000000 ffff8800e75bb990 ffffffff816e7335 00000000002000d0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292399]  ffff8800e75bba00 ffffffff816e2290 000000000000965b 0000000001320122\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292401]  0000000000000000 0000000000000000 ffff8800e789c650 ffffffff00000000\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292404] Call Trace:\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292412]  [<ffffffff816e7335>] dump_stack+0x45/0x56\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292414]  [<ffffffff816e2290>] dump_header+0x7f/0x1c2\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292419]  [<ffffffff81142449>] oom_kill_process+0x1a9/0x310\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292422]  [<ffffffff812dc4a5>] ? security_capable_noaudit+0x15/0x20\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292424]  [<ffffffff81142b84>] out_of_memory+0x414/0x450\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292427]  [<ffffffff81148360>] __alloc_pages_nodemask+0x870/0x920\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292431]  [<ffffffff81183c69>] alloc_pages_current+0xa9/0x160\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292434]  [<ffffffff8118c17d>] new_slab+0x2ed/0x300\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292436]  [<ffffffff816e3699>] __slab_alloc+0x2a8/0x459\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292440]  [<ffffffff811a8e0c>] ? get_empty_filp+0x5c/0x190\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292442]  [<ffffffff811b14f1>] ? terminate_walk+0x51/0x60\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292445]  [<ffffffff811a8e0c>] ? get_empty_filp+0x5c/0x190\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292447]  [<ffffffff8118db83>] kmem_cache_alloc+0x113/0x120\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292451]  [<ffffffff810fe7cf>] ? __call_rcu+0xbf/0x2c0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292453]  [<ffffffff811a8e0c>] get_empty_filp+0x5c/0x190\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292456]  [<ffffffff811b5d9c>] path_openat+0x3c/0x630\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292459]  [<ffffffff811681f9>] ? handle_mm_fault+0x299/0x670\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292463]  [<ffffffff81009e8d>] ? xen_force_evtchn_callback+0xd/0x10\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292466]  [<ffffffff811b719a>] do_filp_open+0x3a/0x90\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292468]  [<ffffffff8118daa1>] ? kmem_cache_alloc+0x31/0x120\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292471]  [<ffffffff811b642f>] ? getname_flags+0x4f/0x190\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292474]  [<ffffffff816ee5be>] ? _raw_spin_lock+0xe/0x20\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292476]  [<ffffffff811c3af7>] ? __alloc_fd+0xa7/0x130\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292479]  [<ffffffff811a640c>] do_sys_open+0x12c/0x270\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292482]  [<ffffffff810b786e>] ? getnstimeofday+0xe/0x30\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292485]  [<ffffffff811a656e>] SyS_open+0x1e/0x20\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292488]  [<ffffffff816f721d>] system_call_fastpath+0x1a/0x1f\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292489] Mem-Info:\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292490] Node 0 DMA per-cpu:\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292492] CPU    0: hi:    0, btch:   1 usd:   0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292493] Node 0 DMA32 per-cpu:\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292495] CPU    0: hi:  186, btch:  31 usd: 101\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498] active_anon:939335 inactive_anon:44 isolated_anon:0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498]  active_file:24 inactive_file:72 isolated_file:0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498]  unevictable:0 dirty:0 writeback:0 unstable:0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498]  free:5684 slab_reclaimable:2034 slab_unreclaimable:2145\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498]  mapped:46 shmem:54 pagetables:2431 bounce:0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292498]  free_cma:0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292500] Node 0 DMA free:14952kB min:32kB low:40kB high:48kB active_anon:960kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:15996kB managed:15912kB mlocked:0kB dirty:0kB writeback:0kB mapped:0kB shmem:0kB slab_reclaimable:0kB slab_unreclaimable:0kB kernel_stack:0kB pagetables:0kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? yes\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292504] lowmem_reserve[]: 0 3730 3730 3730\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292506] Node 0 DMA32 free:7784kB min:7796kB low:9744kB high:11692kB active_anon:3756380kB inactive_anon:176kB active_file:96kB inactive_file:288kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:3923968kB managed:3823304kB mlocked:0kB dirty:0kB writeback:0kB mapped:184kB shmem:216kB slab_reclaimable:8136kB slab_unreclaimable:8580kB kernel_stack:1240kB pagetables:9724kB unstable:0kB bounce:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:4697857 all_unreclaimable? yes\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292510] lowmem_reserve[]: 0 0 0 0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292512] Node 0 DMA: 0*4kB 1*8kB (U) 0*16kB 1*32kB (U) 3*64kB (UM) 1*128kB (U) 1*256kB (U) 0*512kB 2*1024kB (UM) 2*2048kB (MR) 2*4096kB (M) = 14952kB\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292522] Node 0 DMA32: 0*4kB 35*8kB (E) 23*16kB (EM) 19*32kB (UEM) 4*64kB (UE) 9*128kB (UEM) 4*256kB (UEM) 0*512kB 0*1024kB 0*2048kB 1*4096kB (R) = 7784kB\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292532] Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292533] 170 total pagecache pages\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292534] 0 pages in swap cache\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292536] Swap cache stats: add 0, delete 0, find 0/0\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292536] Free swap  = 0kB\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.292537] Total swap = 0kB\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298359] 985087 pages RAM\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298362] 25283 pages reserved\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298363] 262592 pages shared\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298364] 953625 pages non-shared\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298365] [ pid ]   uid  tgid total_vm      rss nr_ptes swapents oom_score_adj name\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298372] [  307]     0   307     4330       46      13        0             0 upstart-udev-br\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298374] [  317]     0   317    10208      122      23        0         -1000 systemd-udevd\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298377] [  429]     0   429     3815       57      12        0             0 upstart-socket-\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298379] [  560]     0   560     2559      574       9        0             0 dhclient\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298381] [  792]   102   792     7624       89      19        0             0 dbus-daemon\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298383] [  852]   101   852    62925      211      25        0             0 rsyslogd\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298385] [  880]     0   880     3851       75      13        0             0 upstart-file-br\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298387] [  887]     0   887     9264       80      23        0             0 systemd-logind\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298388] [  942]     0   942     3637       42      12        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298390] [  949]     0   949     3637       39      11        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298391] [  956]     0   956     3637       42      12        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298393] [  957]     0   957     3637       43      11        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298395] [  959]     0   959     3637       42      12        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298396] [ 1001]     0  1001    15273      161      33        0         -1000 sshd\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298398] [ 1006]     0  1006     1094       36       8        0             0 acpid\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298400] [ 1010]     0  1010     4781       43      12        0             0 atd\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298401] [ 1011]     0  1011     6451       66      17        0             0 cron\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298403] [ 1084]   105  1084    83826      283      62        0             0 whoopsie\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298405] [ 1235]     0  1235     9231      139      20        0             0 monit\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298407] [ 1253]     0  1253     3637       42      11        0             0 getty\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298409] [ 1369]   106  1369     8400      152      20        0             0 ntpd\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298411] [ 4928]   107  4928   981128   933204    1904        0             0 rethinkdb\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298413] [ 5442]     0  5442    12791      104      29        0             0 cron\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298414] [ 5445]     0  5445     1110       26       8        0             0 sh\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298416] [ 5446]     0  5446     1086       27       7        0             0 run-parts\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298417] [ 5451]     0  5451     1110       34       7        0             0 apt\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298419] [ 5463]     0  5463     6538       76      17        0             0 apt-get\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298421] [ 5466]     0  5466    10557     1632      25        0             0 apport\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298423] [ 5473]     0  5473    12791      105      29        0             0 cron\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298424] [ 5474]     0  5474     1081       16       6        0             0 sh\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298426] Out of memory: Kill process 4928 (rethinkdb) score 974 or sacrifice child\r\nMay 18 06:47:58 ip-10-79-143-86 kernel: [352134.298441] Killed process 4928 (rethinkdb) total-vm:3924512kB, anon-rss:3732816kB, file-rss:0kB\r\n</pre>\r\n\r\nData directories:\r\n<pre>\r\nInstance 1 data directory:\r\ntotal 2.2G\r\n-rw-r--r-- 1 rethinkdb rethinkdb 2.0G May 19 14:40 0fa99d7b-673b-40dd-b183-8dab41aaf212\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:20 2262e06f-835e-4840-bd04-f32c5332b6e4\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:37 34220ceb-7e37-49f0-ad20-7050a438f950\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 39392349-2e61-4661-bf07-82a55d9fa6ab\r\n-rw-r--r-- 1 rethinkdb rethinkdb 4.0M May 19 14:20 3bec8eb9-44df-4788-a7d9-898e270e486c\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 69a02958-04e7-4265-8ece-cfb5d4410fb9\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:20 6cafb97f-e01d-4f09-ab29-89ba59081893\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:20 772fcdac-de17-400e-b027-2e87111cdf98\r\n-rw-r--r-- 1 rethinkdb rethinkdb 5.5M May 19 14:12 7da81f67-fc75-483c-9444-0a135a734cb1\r\n-rw-r--r-- 1 rethinkdb rethinkdb  38M May 19 14:39 91324c3d-6647-4064-ad8a-c3a7ef675909\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 13:59 95082f88-b804-4351-994e-1b760aa46a4f\r\n-rw-r--r-- 1 rethinkdb rethinkdb 2.0M May 19 14:20 auth_metadata\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:32 b2342731-332b-43ef-9f46-b0ac9bc88e6d\r\n-rw-r--r-- 1 rethinkdb rethinkdb 119M May 19 14:40 bf2fbdd8-fdb2-4d07-af6c-4ecd662df540\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:00 f134933a-1fb0-48ac-aef7-39f428cc1540\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:21 fb904b45-2cd2-49f1-a2ca-e7147378b05a\r\n-rw-r--r-- 1 rethinkdb rethinkdb  34K May 19 13:58 log_file\r\n-rw-r--r-- 1 rethinkdb rethinkdb 6.5M May 19 14:20 metadata\r\ndrwxr-xr-x 2 rethinkdb rethinkdb    6 May 19 13:58 tmp\r\n\r\nInstance 2 data directory:\r\ntotal 1.9G\r\n-rw-r--r-- 1 rethinkdb rethinkdb 1.7G May 19 14:43 0fa99d7b-673b-40dd-b183-8dab41aaf212\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 2262e06f-835e-4840-bd04-f32c5332b6e4\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:37 34220ceb-7e37-49f0-ad20-7050a438f950\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:20 39392349-2e61-4661-bf07-82a55d9fa6ab\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 3bec8eb9-44df-4788-a7d9-898e270e486c\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:20 69a02958-04e7-4265-8ece-cfb5d4410fb9\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 6cafb97f-e01d-4f09-ab29-89ba59081893\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.0M May 19 14:20 772fcdac-de17-400e-b027-2e87111cdf98\r\n-rw-r--r-- 1 rethinkdb rethinkdb 6.0M May 19 14:12 7da81f67-fc75-483c-9444-0a135a734cb1\r\n-rw-r--r-- 1 rethinkdb rethinkdb  38M May 19 14:42 91324c3d-6647-4064-ad8a-c3a7ef675909\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:00 95082f88-b804-4351-994e-1b760aa46a4f\r\n-rw-r--r-- 1 rethinkdb rethinkdb 2.0M May 19 14:20 auth_metadata\r\n-rw-r--r-- 1 rethinkdb rethinkdb 4.0M May 19 14:32 b2342731-332b-43ef-9f46-b0ac9bc88e6d\r\n-rw-r--r-- 1 rethinkdb rethinkdb 121M May 19 14:43 bf2fbdd8-fdb2-4d07-af6c-4ecd662df540\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 13:51 f134933a-1fb0-48ac-aef7-39f428cc1540\r\n-rw-r--r-- 1 rethinkdb rethinkdb 3.5M May 19 14:21 fb904b45-2cd2-49f1-a2ca-e7147378b05a\r\n-rw-r--r-- 1 rethinkdb rethinkdb  14K May 19 13:58 log_file\r\n-rw-r--r-- 1 rethinkdb rethinkdb 6.5M May 19 14:20 metadata\r\ndrwxr-xr-x 2 rethinkdb rethinkdb    6 May 19 13:50 tmp\r\n</pre>"
  , issueCommentId = 43517297
  }