Issue
  { issueClosedAt = Just 2015 (-04) (-09) 21 : 24 : 50 UTC
  , issueUpdatedAt = 2015 (-04) (-16) 02 : 03 : 20 UTC
  , issueEventsUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/4037/events"
  , issueHtmlUrl =
      Just "https://github.com/rethinkdb/rethinkdb/issues/4037"
  , issueClosedBy = Nothing
  , issueLabels =
      [ IssueLabel
          { labelColor = "fef2c0"
          , labelUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/labels/JavaScript%20/%20Coffee"
          , labelName = "JavaScript / Coffee"
          }
      , IssueLabel
          { labelColor = "e102d8"
          , labelUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/labels/tp:bug"
          , labelName = "tp:bug"
          }
      ]
  , issueNumber = 4037
  , issueAssignee =
      Just
        SimpleUser
          { simpleUserId = Id 1366
          , simpleUserLogin = N "deontologician"
          , simpleUserAvatarUrl =
              "https://avatars.githubusercontent.com/u/1366?v=3"
          , simpleUserUrl = "https://api.github.com/users/deontologician"
          , simpleUserType = OwnerUser
          }
  , issueUser =
      SimpleUser
        { simpleUserId = Id 1213510
        , simpleUserLogin = N "jmdobry"
        , simpleUserAvatarUrl =
            "https://avatars.githubusercontent.com/u/1213510?v=3"
        , simpleUserUrl = "https://api.github.com/users/jmdobry"
        , simpleUserType = OwnerUser
        }
  , issueTitle = "Strange issue on node webkit"
  , issuePullRequest = Nothing
  , issueUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/4037"
  , issueCreatedAt = 2015 (-04) (-09) 15 : 22 : 54 UTC
  , issueBody =
      Just
        "- rethinkdb 1.16.3\r\n- rethinkdb.js 1.16.2\r\n- nw.js 0.12.0\r\n\r\nI'm attempting to run this query in node webkit:\r\n\r\n`test.js`:\r\n\r\n```js\r\nvar r = require('rethinkdb');\r\nvar conn;\r\n\r\nr.connect().then(function (connection) {\r\n  conn = connection;\r\n  return r.db('rethinkdb')\r\n          .table('table_config', { identifier_format: 'uuid' })\r\n          .eqJoin('id', r.db('rethinkdb').table('table_status', { identifier_format: 'uuid' }))\r\n          .zip()\r\n          .map(function (table) {\r\n           return table.merge(function (table) {\r\n             return {\r\n               shards: table('shards').map(function (shard) {\r\n                 return shard.merge(function (shard) {\r\n                   return {\r\n                     replicas: shard('replicas').innerJoin(\r\n                       r.db('rethinkdb')\r\n                         .table('stats', { identifier_format: 'uuid' })\r\n                         .filter(function (stat) {\r\n                            return stat('table').eq(table('id')).and(stat.hasFields('storage_engine'));\r\n                          })\r\n                         .without('id', 'table', 'db'),\r\n                       function (replicaRow, statRow) {\r\n                        return replicaRow('server').eq(statRow('server'));\r\n                      }\r\n                     ).zip().coerceTo('array')\r\n                   };\r\n                 });\r\n               }).coerceTo('array')\r\n             };\r\n           });\r\n          })\r\n          .coerceTo('array')\r\n          .run(connection);\r\n}).then(function (tables) {\r\n  console.log(tables);\r\n}).catch(function (err) {\r\n  console.error(err);\r\n}).finally(function () {\r\n  if (conn) {\r\n    conn.close();\r\n  }\r\n});\r\n```\r\n\r\nIt runs fine in the web console and when I just run `node test.js`. When executed from node webkit it fails with the following error:\r\n\r\n```\r\nUnhandled rejection RqlRuntimeError: Expected type FUNCTION but found DATUM:\r\nnull in:\r\nr.db(\"rethinkdb\").table(\"table_config\", {identifierFormat: \"uuid\"}).eqJoin(\"id\", r.db(\"rethinkdb\").table(\"table_status\", {identifierFormat: \"uuid\"})).zip().map(function (table) {\r\n        return table.merge(function (table) {\r\n          return {\r\n            shards: table('shards').map(function (shard) {\r\n              return shard.merge(function (shard) {\r\n                return {\r\n                  replicas: shard('replicas').innerJoin(r.db('rethinkdb').table('stats', { identifier_format: 'uuid' }).filter(function (stat) {\r\n                    return stat('table').eq(table('id')).and(stat.hasFields('storage_engine'));\r\n                  }).without('id', 'table', 'db'), function (replicaRow, statRow) {\r\n                    return replicaRow('server').eq(statRow('server'));\r\n                  }).zip().coerceTo('array')\r\n                };\r\n              });\r\n            }).coerceTo('array')\r\n          };\r\n        });\r\n      }).coerceTo(\"array\")\r\n                                                                                                                                                                                                                     ^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^ ^^^^^^^^^^ ^^^^^^                   \r\n    at RqlRuntimeError.RqlServerError (/Users/test/test/node_modules/rethinkdb/errors.js:39:13)\r\n    at new RqlRuntimeError (/Users/test/test/node_modules/rethinkdb/errors.js:51:50)\r\n    at mkErr (/Users/test/test/node_modules/rethinkdb/util.js:173:10)\r\n    at TcpConnection.Connection._processResponse (/Users/test/test/node_modules/rethinkdb/net.js:138:16)\r\n    at TcpConnection.Connection._data (/Users/test/test/node_modules/rethinkdb/net.js:104:12)\r\n    at Socket.<anonymous> (/Users/test/test/node_modules/rethinkdb/net.js:495:32)\r\n    at emitOne (events.js:75:13)\r\n    at Socket.emit (events.js:150:7)\r\n    at readableAddChunk (_stream_readable.js:146:16)\r\n    at Socket.Readable.push (_stream_readable.js:109:10)\r\n    at TCP.onread (net.js:510:20)\r\nFrom previous event:\r\n    at CoerceTo.TermBase.run (/Users/test/test/node_modules/rethinkdb/ast.js:131:12)\r\n    at file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2737:27\r\nFrom previous event:\r\n    at getTables (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2719:23)\r\n    at Database.<anonymous> (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2793:15)\r\n    at Database.getTables (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2781:28)\r\n    at file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:570:19\r\n    at processImmediate [as _immediateCallback] (timers.js:321:17)\r\nFrom previous event:\r\n    at connect (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:559:9)\r\n    at Object.executeDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18453:22)\r\n    at SimpleEventPlugin.executeDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:30422:41)\r\n    at forEachEventDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18441:6)\r\n    at Object.executeDispatchesInOrder (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18462:4)\r\n    at executeDispatchesAndRelease (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:50334:23)\r\n    at Array.forEach (native)\r\n    at forEachAccumulated (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:56988:10)\r\n    at Object.EventPluginHub.processEventQueue (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:50541:6)\r\n    at runEventQueueInBatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:53472:19)\r\n    at Object.ReactEventEmitterMixin.handleTopLevel [as _handleTopLevel] (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:53498:6)\r\n    at handleTopLevelImpl (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:29550:25)\r\n    at ReactDefaultBatchingStrategyTransaction.Mixin.perform (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:51344:21)\r\n    at Object.ReactDefaultBatchingStrategy.batchedUpdates (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:28508:20)\r\n    at Object.batchedUpdates (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:31933:21)\r\n    at ReactEventListener.dispatchEvent (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:29644:21)\r\n```\r\n\r\nDoing some debugging, when running normally the `_sendQuery` method sends the following JSON:\r\n\r\n```json\r\n[\r\n  1,\r\n  [\r\n    51,\r\n    [\r\n      [\r\n        38,\r\n        [\r\n          [\r\n            72,\r\n            [\r\n              [\r\n                50,\r\n                [\r\n                  [\r\n                    15,\r\n                    [\r\n                      [\r\n                        14,\r\n                        [\r\n                          \"rethinkdb\"\r\n                        ]\r\n                      ],\r\n                      \"table_config\"\r\n                    ],\r\n                    {\r\n                      \"identifier_format\": \"uuid\"\r\n                    }\r\n                  ],\r\n                  \"id\",\r\n                  [\r\n                    15,\r\n                    [\r\n                      [\r\n                        14,\r\n                        [\r\n                          \"rethinkdb\"\r\n                        ]\r\n                      ],\r\n                      \"table_status\"\r\n                    ],\r\n                    {\r\n                      \"identifier_format\": \"uuid\"\r\n                    }\r\n                  ]\r\n                ]\r\n              ]\r\n            ]\r\n          ],\r\n          [\r\n            69,\r\n            [\r\n              [\r\n                2,\r\n                [\r\n                  0\r\n                ]\r\n              ],\r\n              [\r\n                35,\r\n                [\r\n                  [\r\n                    10,\r\n                    [\r\n                      0\r\n                    ]\r\n                  ],\r\n                  [\r\n                    69,\r\n                    [\r\n                      [\r\n                        2,\r\n                        [\r\n                          1\r\n                        ]\r\n                      ],\r\n                      {\r\n                        \"shards\": [\r\n                          51,\r\n                          [\r\n                            [\r\n                              38,\r\n                              [\r\n                                [\r\n                                  170,\r\n                                  [\r\n                                    [\r\n                                      10,\r\n                                      [\r\n                                        1\r\n                                      ]\r\n                                    ],\r\n                                    \"shards\"\r\n                                  ]\r\n                                ],\r\n                                [\r\n                                  69,\r\n                                  [\r\n                                    [\r\n                                      2,\r\n                                      [\r\n                                        2\r\n                                      ]\r\n                                    ],\r\n                                    [\r\n                                      35,\r\n                                      [\r\n                                        [\r\n                                          10,\r\n                                          [\r\n                                            2\r\n                                          ]\r\n                                        ],\r\n                                        [\r\n                                          69,\r\n                                          [\r\n                                            [\r\n                                              2,\r\n                                              [\r\n                                                3\r\n                                              ]\r\n                                            ],\r\n                                            {\r\n                                              \"replicas\": [\r\n                                                51,\r\n                                                [\r\n                                                  [\r\n                                                    72,\r\n                                                    [\r\n                                                      [\r\n                                                        48,\r\n                                                        [\r\n                                                          [\r\n                                                            170,\r\n                                                            [\r\n                                                              [\r\n                                                                10,\r\n                                                                [\r\n                                                                  3\r\n                                                                ]\r\n                                                              ],\r\n                                                              \"replicas\"\r\n                                                            ]\r\n                                                          ],\r\n                                                          [\r\n                                                            34,\r\n                                                            [\r\n                                                              [\r\n                                                                39,\r\n                                                                [\r\n                                                                  [\r\n                                                                    15,\r\n                                                                    [\r\n                                                                      [\r\n                                                                        14,\r\n                                                                        [\r\n                                                                          \"rethinkdb\"\r\n                                                                        ]\r\n                                                                      ],\r\n                                                                      \"stats\"\r\n                                                                    ],\r\n                                                                    {\r\n                                                                      \"identifier_format\": \"uuid\"\r\n                                                                    }\r\n                                                                  ],\r\n                                                                  [\r\n                                                                    69,\r\n                                                                    [\r\n                                                                      [\r\n                                                                        2,\r\n                                                                        [\r\n                                                                          4\r\n                                                                        ]\r\n                                                                      ],\r\n                                                                      [\r\n                                                                        67,\r\n                                                                        [\r\n                                                                          [\r\n                                                                            17,\r\n                                                                            [\r\n                                                                              [\r\n                                                                                170,\r\n                                                                                [\r\n                                                                                  [\r\n                                                                                    10,\r\n                                                                                    [\r\n                                                                                      4\r\n                                                                                    ]\r\n                                                                                  ],\r\n                                                                                  \"table\"\r\n                                                                                ]\r\n                                                                              ],\r\n                                                                              [\r\n                                                                                170,\r\n                                                                                [\r\n                                                                                  [\r\n                                                                                    10,\r\n                                                                                    [\r\n                                                                                      1\r\n                                                                                    ]\r\n                                                                                  ],\r\n                                                                                  \"id\"\r\n                                                                                ]\r\n                                                                              ]\r\n                                                                            ]\r\n                                                                          ],\r\n                                                                          [\r\n                                                                            32,\r\n                                                                            [\r\n                                                                              [\r\n                                                                                10,\r\n                                                                                [\r\n                                                                                  4\r\n                                                                                ]\r\n                                                                              ],\r\n                                                                              \"storage_engine\"\r\n                                                                            ]\r\n                                                                          ]\r\n                                                                        ]\r\n                                                                      ]\r\n                                                                    ]\r\n                                                                  ]\r\n                                                                ]\r\n                                                              ],\r\n                                                              \"id\",\r\n                                                              \"table\",\r\n                                                              \"db\"\r\n                                                            ]\r\n                                                          ],\r\n                                                          [\r\n                                                            69,\r\n                                                            [\r\n                                                              [\r\n                                                                2,\r\n                                                                [\r\n                                                                  5,\r\n                                                                  6\r\n                                                                ]\r\n                                                              ],\r\n                                                              [\r\n                                                                17,\r\n                                                                [\r\n                                                                  [\r\n                                                                    170,\r\n                                                                    [\r\n                                                                      [\r\n                                                                        10,\r\n                                                                        [\r\n                                                                          5\r\n                                                                        ]\r\n                                                                      ],\r\n                                                                      \"server\"\r\n                                                                    ]\r\n                                                                  ],\r\n                                                                  [\r\n                                                                    170,\r\n                                                                    [\r\n                                                                      [\r\n                                                                        10,\r\n                                                                        [\r\n                                                                          6\r\n                                                                        ]\r\n                                                                      ],\r\n                                                                      \"server\"\r\n                                                                    ]\r\n                                                                  ]\r\n                                                                ]\r\n                                                              ]\r\n                                                            ]\r\n                                                          ]\r\n                                                        ]\r\n                                                      ]\r\n                                                    ]\r\n                                                  ],\r\n                                                  \"array\"\r\n                                                ]\r\n                                              ]\r\n                                            }\r\n                                          ]\r\n                                        ]\r\n                                      ]\r\n                                    ]\r\n                                  ]\r\n                                ]\r\n                              ]\r\n                            ],\r\n                            \"array\"\r\n                          ]\r\n                        ]\r\n                      }\r\n                    ]\r\n                  ]\r\n                ]\r\n              ]\r\n            ]\r\n          ]\r\n        ]\r\n      ],\r\n      \"array\"\r\n    ]\r\n  ]\r\n]\r\n```\r\n\r\nbut when it executes in node webkit it only sends the following JSON:\r\n\r\n```json\r\n[\r\n  1,\r\n  [\r\n    51,\r\n    [\r\n      [\r\n        38,\r\n        [\r\n          [\r\n            72,\r\n            [\r\n              [\r\n                50,\r\n                [\r\n                  [\r\n                    39,\r\n                    [\r\n                      [\r\n                        15,\r\n                        [\r\n                          [\r\n                            14,\r\n                            [\r\n                              \"rethinkdb\"\r\n                            ]\r\n                          ],\r\n                          \"table_config\"\r\n                        ],\r\n                        {\r\n                          \"identifier_format\": \"uuid\"\r\n                        }\r\n                      ],\r\n                      {\r\n                        \"db\": \"2c9d502f-4c95-4cd1-9884-c026d445a180\"\r\n                      }\r\n                    ]\r\n                  ],\r\n                  \"id\",\r\n                  [\r\n                    15,\r\n                    [\r\n                      [\r\n                        14,\r\n                        [\r\n                          \"rethinkdb\"\r\n                        ]\r\n                      ],\r\n                      \"table_status\"\r\n                    ],\r\n                    {\r\n                      \"identifier_format\": \"uuid\"\r\n                    }\r\n                  ]\r\n                ]\r\n              ]\r\n            ]\r\n          ],\r\n          null\r\n        ]\r\n      ],\r\n      \"array\"\r\n    ]\r\n  ]\r\n]\r\n```\r\n\r\nI'm guessing there's some sort of difference in the node environment that the rethinkdb driver isn't expecting, as it doesn't appear to be building the query correctly before it sends it to the server.\r\n\r\nAny hints, tips, pointers, ideas?"
  , issueState = "closed"
  , issueId = Id 67385421
  , issueComments = 6
  , issueMilestone =
      Just
        Milestone
          { milestoneCreator =
              SimpleUser
                { simpleUserId = Id 505365
                , simpleUserLogin = N "danielmewes"
                , simpleUserAvatarUrl =
                    "https://avatars.githubusercontent.com/u/505365?v=3"
                , simpleUserUrl = "https://api.github.com/users/danielmewes"
                , simpleUserType = OwnerUser
                }
          , milestoneDueOn = Nothing
          , milestoneOpenIssues = 0
          , milestoneNumber = 89
          , milestoneClosedIssues = 117
          , milestoneDescription = Just ""
          , milestoneTitle = "2.0"
          , milestoneUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/milestones/89"
          , milestoneCreatedAt = 2015 (-01) (-26) 07 : 45 : 17 UTC
          , milestoneState = "closed"
          }
  }