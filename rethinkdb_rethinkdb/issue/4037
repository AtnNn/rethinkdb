Issue
  { issueClosedAt = Just 2015 (-04) (-09) 21 : 24 : 50 UTC
  , issueUpdatedAt = 2015 (-04) (-16) 02 : 03 : 20 UTC
  , issueEventsUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/4037/events"
  , issueHtmlUrl =
      Just "https://github.com/rethinkdb/rethinkdb/issues/4037"
  , issueClosedBy = Nothing
  , issueLabels =
      [ IssueLabel
          { labelColor = "fef2c0"
          , labelUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/labels/JavaScript%20/%20Coffee"
          , labelName = "JavaScript / Coffee"
          }
      , IssueLabel
          { labelColor = "e102d8"
          , labelUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/labels/tp:bug"
          , labelName = "tp:bug"
          }
      ]
  , issueNumber = 4037
  , issueAssignee =
      Just
        SimpleUser
          { simpleUserId = Id 1366
          , simpleUserLogin = N "deontologician"
          , simpleUserAvatarUrl =
              "https://avatars.githubusercontent.com/u/1366?v=3"
          , simpleUserUrl = "https://api.github.com/users/deontologician"
          , simpleUserType = OwnerUser
          }
  , issueUser =
      SimpleUser
        { simpleUserId = Id 1213510
        , simpleUserLogin = N "jmdobry"
        , simpleUserAvatarUrl =
            "https://avatars.githubusercontent.com/u/1213510?v=3"
        , simpleUserUrl = "https://api.github.com/users/jmdobry"
        , simpleUserType = OwnerUser
        }
  , issueTitle = "Strange issue on node webkit"
  , issuePullRequest = Nothing
  , issueUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/4037"
  , issueCreatedAt = 2015 (-04) (-09) 15 : 22 : 54 UTC
  , issueBody =
      Just
        "- rethinkdb 1.16.3\n- rethinkdb.js 1.16.2\n- nw.js 0.12.0\n\nI'm attempting to run this query in node webkit:\n\n`test.js`:\n\n``` js\nvar r = require('rethinkdb');\nvar conn;\n\nr.connect().then(function (connection) {\n  conn = connection;\n  return r.db('rethinkdb')\n          .table('table_config', { identifier_format: 'uuid' })\n          .eqJoin('id', r.db('rethinkdb').table('table_status', { identifier_format: 'uuid' }))\n          .zip()\n          .map(function (table) {\n           return table.merge(function (table) {\n             return {\n               shards: table('shards').map(function (shard) {\n                 return shard.merge(function (shard) {\n                   return {\n                     replicas: shard('replicas').innerJoin(\n                       r.db('rethinkdb')\n                         .table('stats', { identifier_format: 'uuid' })\n                         .filter(function (stat) {\n                            return stat('table').eq(table('id')).and(stat.hasFields('storage_engine'));\n                          })\n                         .without('id', 'table', 'db'),\n                       function (replicaRow, statRow) {\n                        return replicaRow('server').eq(statRow('server'));\n                      }\n                     ).zip().coerceTo('array')\n                   };\n                 });\n               }).coerceTo('array')\n             };\n           });\n          })\n          .coerceTo('array')\n          .run(connection);\n}).then(function (tables) {\n  console.log(tables);\n}).catch(function (err) {\n  console.error(err);\n}).finally(function () {\n  if (conn) {\n    conn.close();\n  }\n});\n```\n\nIt runs fine in the web console and when I just run `node test.js`. When executed from node webkit it fails with the following error:\n\n```\nUnhandled rejection RqlRuntimeError: Expected type FUNCTION but found DATUM:\nnull in:\nr.db(\"rethinkdb\").table(\"table_config\", {identifierFormat: \"uuid\"}).eqJoin(\"id\", r.db(\"rethinkdb\").table(\"table_status\", {identifierFormat: \"uuid\"})).zip().map(function (table) {\n        return table.merge(function (table) {\n          return {\n            shards: table('shards').map(function (shard) {\n              return shard.merge(function (shard) {\n                return {\n                  replicas: shard('replicas').innerJoin(r.db('rethinkdb').table('stats', { identifier_format: 'uuid' }).filter(function (stat) {\n                    return stat('table').eq(table('id')).and(stat.hasFields('storage_engine'));\n                  }).without('id', 'table', 'db'), function (replicaRow, statRow) {\n                    return replicaRow('server').eq(statRow('server'));\n                  }).zip().coerceTo('array')\n                };\n              });\n            }).coerceTo('array')\n          };\n        });\n      }).coerceTo(\"array\")\n                                                                                                                                                                                                                     ^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^ ^^^^^^^^^^ ^^^^^^                   \n    at RqlRuntimeError.RqlServerError (/Users/test/test/node_modules/rethinkdb/errors.js:39:13)\n    at new RqlRuntimeError (/Users/test/test/node_modules/rethinkdb/errors.js:51:50)\n    at mkErr (/Users/test/test/node_modules/rethinkdb/util.js:173:10)\n    at TcpConnection.Connection._processResponse (/Users/test/test/node_modules/rethinkdb/net.js:138:16)\n    at TcpConnection.Connection._data (/Users/test/test/node_modules/rethinkdb/net.js:104:12)\n    at Socket.<anonymous> (/Users/test/test/node_modules/rethinkdb/net.js:495:32)\n    at emitOne (events.js:75:13)\n    at Socket.emit (events.js:150:7)\n    at readableAddChunk (_stream_readable.js:146:16)\n    at Socket.Readable.push (_stream_readable.js:109:10)\n    at TCP.onread (net.js:510:20)\nFrom previous event:\n    at CoerceTo.TermBase.run (/Users/test/test/node_modules/rethinkdb/ast.js:131:12)\n    at file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2737:27\nFrom previous event:\n    at getTables (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2719:23)\n    at Database.<anonymous> (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2793:15)\n    at Database.getTables (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:2781:28)\n    at file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:570:19\n    at processImmediate [as _immediateCallback] (timers.js:321:17)\nFrom previous event:\n    at connect (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:559:9)\n    at Object.executeDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18453:22)\n    at SimpleEventPlugin.executeDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:30422:41)\n    at forEachEventDispatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18441:6)\n    at Object.executeDispatchesInOrder (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:18462:4)\n    at executeDispatchesAndRelease (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:50334:23)\n    at Array.forEach (native)\n    at forEachAccumulated (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:56988:10)\n    at Object.EventPluginHub.processEventQueue (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:50541:6)\n    at runEventQueueInBatch (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:53472:19)\n    at Object.ReactEventEmitterMixin.handleTopLevel [as _handleTopLevel] (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:53498:6)\n    at handleTopLevelImpl (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:29550:25)\n    at ReactDefaultBatchingStrategyTransaction.Mixin.perform (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:51344:21)\n    at Object.ReactDefaultBatchingStrategy.batchedUpdates (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:28508:20)\n    at Object.batchedUpdates (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:31933:21)\n    at ReactEventListener.dispatchEvent (file:///Users/test/test/build/test/osx64/test.app/Contents/Resources/app.nw/js/app.js:29644:21)\n```\n\nDoing some debugging, when running normally the `_sendQuery` method sends the following JSON:\n\n``` json\n[\n  1,\n  [\n    51,\n    [\n      [\n        38,\n        [\n          [\n            72,\n            [\n              [\n                50,\n                [\n                  [\n                    15,\n                    [\n                      [\n                        14,\n                        [\n                          \"rethinkdb\"\n                        ]\n                      ],\n                      \"table_config\"\n                    ],\n                    {\n                      \"identifier_format\": \"uuid\"\n                    }\n                  ],\n                  \"id\",\n                  [\n                    15,\n                    [\n                      [\n                        14,\n                        [\n                          \"rethinkdb\"\n                        ]\n                      ],\n                      \"table_status\"\n                    ],\n                    {\n                      \"identifier_format\": \"uuid\"\n                    }\n                  ]\n                ]\n              ]\n            ]\n          ],\n          [\n            69,\n            [\n              [\n                2,\n                [\n                  0\n                ]\n              ],\n              [\n                35,\n                [\n                  [\n                    10,\n                    [\n                      0\n                    ]\n                  ],\n                  [\n                    69,\n                    [\n                      [\n                        2,\n                        [\n                          1\n                        ]\n                      ],\n                      {\n                        \"shards\": [\n                          51,\n                          [\n                            [\n                              38,\n                              [\n                                [\n                                  170,\n                                  [\n                                    [\n                                      10,\n                                      [\n                                        1\n                                      ]\n                                    ],\n                                    \"shards\"\n                                  ]\n                                ],\n                                [\n                                  69,\n                                  [\n                                    [\n                                      2,\n                                      [\n                                        2\n                                      ]\n                                    ],\n                                    [\n                                      35,\n                                      [\n                                        [\n                                          10,\n                                          [\n                                            2\n                                          ]\n                                        ],\n                                        [\n                                          69,\n                                          [\n                                            [\n                                              2,\n                                              [\n                                                3\n                                              ]\n                                            ],\n                                            {\n                                              \"replicas\": [\n                                                51,\n                                                [\n                                                  [\n                                                    72,\n                                                    [\n                                                      [\n                                                        48,\n                                                        [\n                                                          [\n                                                            170,\n                                                            [\n                                                              [\n                                                                10,\n                                                                [\n                                                                  3\n                                                                ]\n                                                              ],\n                                                              \"replicas\"\n                                                            ]\n                                                          ],\n                                                          [\n                                                            34,\n                                                            [\n                                                              [\n                                                                39,\n                                                                [\n                                                                  [\n                                                                    15,\n                                                                    [\n                                                                      [\n                                                                        14,\n                                                                        [\n                                                                          \"rethinkdb\"\n                                                                        ]\n                                                                      ],\n                                                                      \"stats\"\n                                                                    ],\n                                                                    {\n                                                                      \"identifier_format\": \"uuid\"\n                                                                    }\n                                                                  ],\n                                                                  [\n                                                                    69,\n                                                                    [\n                                                                      [\n                                                                        2,\n                                                                        [\n                                                                          4\n                                                                        ]\n                                                                      ],\n                                                                      [\n                                                                        67,\n                                                                        [\n                                                                          [\n                                                                            17,\n                                                                            [\n                                                                              [\n                                                                                170,\n                                                                                [\n                                                                                  [\n                                                                                    10,\n                                                                                    [\n                                                                                      4\n                                                                                    ]\n                                                                                  ],\n                                                                                  \"table\"\n                                                                                ]\n                                                                              ],\n                                                                              [\n                                                                                170,\n                                                                                [\n                                                                                  [\n                                                                                    10,\n                                                                                    [\n                                                                                      1\n                                                                                    ]\n                                                                                  ],\n                                                                                  \"id\"\n                                                                                ]\n                                                                              ]\n                                                                            ]\n                                                                          ],\n                                                                          [\n                                                                            32,\n                                                                            [\n                                                                              [\n                                                                                10,\n                                                                                [\n                                                                                  4\n                                                                                ]\n                                                                              ],\n                                                                              \"storage_engine\"\n                                                                            ]\n                                                                          ]\n                                                                        ]\n                                                                      ]\n                                                                    ]\n                                                                  ]\n                                                                ]\n                                                              ],\n                                                              \"id\",\n                                                              \"table\",\n                                                              \"db\"\n                                                            ]\n                                                          ],\n                                                          [\n                                                            69,\n                                                            [\n                                                              [\n                                                                2,\n                                                                [\n                                                                  5,\n                                                                  6\n                                                                ]\n                                                              ],\n                                                              [\n                                                                17,\n                                                                [\n                                                                  [\n                                                                    170,\n                                                                    [\n                                                                      [\n                                                                        10,\n                                                                        [\n                                                                          5\n                                                                        ]\n                                                                      ],\n                                                                      \"server\"\n                                                                    ]\n                                                                  ],\n                                                                  [\n                                                                    170,\n                                                                    [\n                                                                      [\n                                                                        10,\n                                                                        [\n                                                                          6\n                                                                        ]\n                                                                      ],\n                                                                      \"server\"\n                                                                    ]\n                                                                  ]\n                                                                ]\n                                                              ]\n                                                            ]\n                                                          ]\n                                                        ]\n                                                      ]\n                                                    ]\n                                                  ],\n                                                  \"array\"\n                                                ]\n                                              ]\n                                            }\n                                          ]\n                                        ]\n                                      ]\n                                    ]\n                                  ]\n                                ]\n                              ]\n                            ],\n                            \"array\"\n                          ]\n                        ]\n                      }\n                    ]\n                  ]\n                ]\n              ]\n            ]\n          ]\n        ]\n      ],\n      \"array\"\n    ]\n  ]\n]\n```\n\nbut when it executes in node webkit it only sends the following JSON:\n\n``` json\n[\n  1,\n  [\n    51,\n    [\n      [\n        38,\n        [\n          [\n            72,\n            [\n              [\n                50,\n                [\n                  [\n                    39,\n                    [\n                      [\n                        15,\n                        [\n                          [\n                            14,\n                            [\n                              \"rethinkdb\"\n                            ]\n                          ],\n                          \"table_config\"\n                        ],\n                        {\n                          \"identifier_format\": \"uuid\"\n                        }\n                      ],\n                      {\n                        \"db\": \"2c9d502f-4c95-4cd1-9884-c026d445a180\"\n                      }\n                    ]\n                  ],\n                  \"id\",\n                  [\n                    15,\n                    [\n                      [\n                        14,\n                        [\n                          \"rethinkdb\"\n                        ]\n                      ],\n                      \"table_status\"\n                    ],\n                    {\n                      \"identifier_format\": \"uuid\"\n                    }\n                  ]\n                ]\n              ]\n            ]\n          ],\n          null\n        ]\n      ],\n      \"array\"\n    ]\n  ]\n]\n```\n\nI'm guessing there's some sort of difference in the node environment that the rethinkdb driver isn't expecting, as it doesn't appear to be building the query correctly before it sends it to the server.\n\nAny hints, tips, pointers, ideas?\n"
  , issueState = "closed"
  , issueId = Id 67385421
  , issueComments = 6
  , issueMilestone =
      Just
        Milestone
          { milestoneCreator =
              SimpleUser
                { simpleUserId = Id 505365
                , simpleUserLogin = N "danielmewes"
                , simpleUserAvatarUrl =
                    "https://avatars.githubusercontent.com/u/505365?v=3"
                , simpleUserUrl = "https://api.github.com/users/danielmewes"
                , simpleUserType = OwnerUser
                }
          , milestoneDueOn = Nothing
          , milestoneOpenIssues = 0
          , milestoneNumber = 89
          , milestoneClosedIssues = 117
          , milestoneDescription = Just ""
          , milestoneTitle = "2.0"
          , milestoneUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/milestones/89"
          , milestoneCreatedAt = 2015 (-01) (-26) 07 : 45 : 17 UTC
          , milestoneState = "closed"
          }
  }