Issue
  { issueClosedAt = Just 2014 (-07) (-25) 01 : 03 : 21 UTC
  , issueUpdatedAt = 2014 (-07) (-25) 01 : 03 : 21 UTC
  , issueEventsUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/2752/events"
  , issueHtmlUrl =
      Just "https://github.com/rethinkdb/rethinkdb/issues/2752"
  , issueClosedBy = Nothing
  , issueLabels = []
  , issueNumber = 2752
  , issueAssignee =
      Just
        SimpleUser
          { simpleUserId = Id 552910
          , simpleUserLogin = N "Tryneus"
          , simpleUserAvatarUrl =
              "https://avatars.githubusercontent.com/u/552910?v=3"
          , simpleUserUrl = "https://api.github.com/users/Tryneus"
          , simpleUserType = OwnerUser
          }
  , issueUser =
      SimpleUser
        { simpleUserId = Id 552910
        , simpleUserLogin = N "Tryneus"
        , simpleUserAvatarUrl =
            "https://avatars.githubusercontent.com/u/552910?v=3"
        , simpleUserUrl = "https://api.github.com/users/Tryneus"
        , simpleUserType = OwnerUser
        }
  , issueTitle =
      "Valgrind warnings due to use of an invalidated iterator"
  , issuePullRequest = Nothing
  , issueUrl =
      "https://api.github.com/repos/rethinkdb/rethinkdb/issues/2752"
  , issueCreatedAt = 2014 (-07) (-24) 22 : 36 : 29 UTC
  , issueBody =
      Just
        "While investigating #2589, I ran across the following valgrind warnings when shutting down the node:\n\n```\n==19623== Invalid read of size 8\n==19623==    at 0x5FBC99E: std::_Rb_tree_increment(std::_Rb_tree_node_base*) (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.16)\n==19623==    by 0x1B044C0: std::_Rb_tree_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >::operator++() (stl_tree.h:188)\n==19623==    by 0x1B12D96: semilattice_manager_t<auth_semilattice_metadata_t>::on_connections_change() (semilattice_manager.tcc:499)\n==19623==    by 0x1B0DB68: _ZZN21semilattice_manager_tI27auth_semilattice_metadata_tEC1EP22connectivity_cluster_thRKS0_ENKUlvE_clEv (semilattice_manager.tcc:32)\n==19623==    by 0x1B16B1C: _ZNSt17_Function_handlerIFvvEZN21semilattice_manager_tI27auth_semilattice_metadata_tEC1EP22connectivity_cluster_thRKS2_EUlvE_E9_M_invokeERKSt9_Any_data (functional:1778)\n==19623==    by 0x1464FFD: std::function<void ()()>::operator()() const (functional:2161)\n==19623==    by 0x15A139C: call_function(std::function<void ()()> const&) (watchable.hpp:166)\n==19623==    by 0x15A2D39: void publisher_controller_t<std::function<void ()()> >::publish<void (*)(std::function<void ()()> const&)>(void (* const&)(std::function<void ()()> const&)) (pubsub.hpp:139)\n==19623==    by 0x1ADC134: watchable_variable_t<std::map<peer_id_t, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t>, std::less<peer_id_t>, std::allocator<std::pair<peer_id_t const, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t> > > > >::apply_atomic_op(std::function<bool ()(std::map<peer_id_t, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t>, std::less<peer_id_t>, std::allocator<std::pair<peer_id_t const, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t> > > >*)> const&) (watchable.hpp:197)\n==19623==    by 0x1AD4F2C: _ZZN22connectivity_cluster_t12connection_tD1EvENKUliE_clEi (cluster.cc:165)\n==19623==    by 0x1ADA31B: _ZN21pmap_runner_one_arg_tIZN22connectivity_cluster_t12connection_tD1EvEUliE_iEclEv (pmap.hpp:18)\n==19623==    by 0x1ADAA0D: _ZN26callable_action_instance_tI21pmap_runner_one_arg_tIZN22connectivity_cluster_t12connection_tD1EvEUliE_iEE10run_actionEv (callable_action.hpp:28)\n==19623==  Address 0x1b20cef8 is 8 bytes inside a block of size 48 free'd\n==19623==    at 0x4C2A4BC: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\n==19623==    by 0x1586DFD: __gnu_cxx::new_allocator<std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::deallocate(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*, unsigned long) (new_allocator.h:98)\n==19623==    by 0x158033D: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_put_node(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:373)\n==19623==    by 0x1575CE9: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_destroy_node(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:420)\n==19623==    by 0x1564174: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_erase(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:1076)\n==19623==    by 0x1B07E54: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::clear() (stl_tree.h:809)\n==19623==    by 0x1B076C1: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_erase_aux(std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >) (stl_tree.h:1501)\n==19623==    by 0x1B06ABE: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >) (stl_tree.h:791)\n==19623==    by 0x1B0583C: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(connectivity_cluster_t::connection_t* const&) (stl_tree.h:1515)\n==19623==    by 0x1B04562: std::map<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(connectivity_cluster_t::connection_t* const&) (stl_map.h:649)\n==19623==    by 0x1B12D7B: semilattice_manager_t<auth_semilattice_metadata_t>::on_connections_change() (semilattice_manager.tcc:503)\n==19623==    by 0x1B0DB68: _ZZN21semilattice_manager_tI27auth_semilattice_metadata_tEC1EP22connectivity_cluster_thRKS0_ENKUlvE_clEv (semilattice_manager.tcc:32)\n```\n\n```\n==19623== Invalid read of size 8\n==19623==    at 0x5FBC980: std::_Rb_tree_increment(std::_Rb_tree_node_base*) (in /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.16)\n==19623==    by 0x1B044C0: std::_Rb_tree_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >::operator++() (stl_tree.h:188)\n==19623==    by 0x1B02519: directory_write_manager_t<cluster_directory_metadata_t>::on_connections_change() (write_manager.tcc:61)\n==19623==    by 0x1B005A8: _ZZN25directory_write_manager_tI28cluster_directory_metadata_tEC1EP22connectivity_cluster_thRK11clone_ptr_tI11watchable_tIS0_EEENKUlvE0_clEv (write_manager.tcc:25)\n==19623==    by 0x1B05B3B: _ZNSt17_Function_handlerIFvvEZN25directory_write_manager_tI28cluster_directory_metadata_tEC1EP22connectivity_cluster_thRK11clone_ptr_tI11watchable_tIS2_EEEUlvE0_E9_M_invokeERKSt9_Any_data (functional:1778)\n==19623==    by 0x1464FFD: std::function<void ()()>::operator()() const (functional:2161)\n==19623==    by 0x15A139C: call_function(std::function<void ()()> const&) (watchable.hpp:166)\n==19623==    by 0x15A2D39: void publisher_controller_t<std::function<void ()()> >::publish<void (*)(std::function<void ()()> const&)>(void (* const&)(std::function<void ()()> const&)) (pubsub.hpp:139)\n==19623==    by 0x1ADC134: watchable_variable_t<std::map<peer_id_t, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t>, std::less<peer_id_t>, std::allocator<std::pair<peer_id_t const, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t> > > > >::apply_atomic_op(std::function<bool ()(std::map<peer_id_t, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t>, std::less<peer_id_t>, std::allocator<std::pair<peer_id_t const, std::pair<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t> > > >*)> const&) (watchable.hpp:197)\n==19623==    by 0x1AD4F2C: _ZZN22connectivity_cluster_t12connection_tD1EvENKUliE_clEi (cluster.cc:165)\n==19623==    by 0x1ADA31B: _ZN21pmap_runner_one_arg_tIZN22connectivity_cluster_t12connection_tD1EvEUliE_iEclEv (pmap.hpp:18)\n==19623==    by 0x1ADAA0D: _ZN26callable_action_instance_tI21pmap_runner_one_arg_tIZN22connectivity_cluster_t12connection_tD1EvEUliE_iEE10run_actionEv (callable_action.hpp:28)\n==19623==  Address 0x1b20d058 is 24 bytes inside a block of size 48 free'd\n==19623==    at 0x4C2A4BC: operator delete(void*) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)\n==19623==    by 0x1586DFD: __gnu_cxx::new_allocator<std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::deallocate(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*, unsigned long) (new_allocator.h:98)\n==19623==    by 0x158033D: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_put_node(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:373)\n==19623==    by 0x1575CE9: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_destroy_node(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:420)\n==19623==    by 0x1564174: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_erase(std::_Rb_tree_node<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >*) (stl_tree.h:1076)\n==19623==    by 0x1B07E54: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::clear() (stl_tree.h:809)\n==19623==    by 0x1B076C1: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::_M_erase_aux(std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >) (stl_tree.h:1501)\n==19623==    by 0x1B06ABE: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::_Rb_tree_const_iterator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >) (stl_tree.h:791)\n==19623==    by 0x1B0583C: std::_Rb_tree<connectivity_cluster_t::connection_t*, std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t>, std::_Select1st<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> >, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(connectivity_cluster_t::connection_t* const&) (stl_tree.h:1515)\n==19623==    by 0x1B04562: std::map<connectivity_cluster_t::connection_t*, auto_drainer_t::lock_t, std::less<connectivity_cluster_t::connection_t*>, std::allocator<std::pair<connectivity_cluster_t::connection_t* const, auto_drainer_t::lock_t> > >::erase(connectivity_cluster_t::connection_t* const&) (stl_map.h:649)\n==19623==    by 0x1B024FB: directory_write_manager_t<cluster_directory_metadata_t>::on_connections_change() (write_manager.tcc:63)\n==19623==    by 0x1B005A8: _ZZN25directory_write_manager_tI28cluster_directory_metadata_tEC1EP22connectivity_cluster_thRK11clone_ptr_tI11watchable_tIS0_EEENKUlvE0_clEv (write_manager.tcc:25)\n```\n\nThese are from loops that delete items as they iterate over a map, but use the invalidated iterator to get the next item.  Fix is up in review 1820.\n"
  , issueState = "closed"
  , issueId = Id 38681363
  , issueComments = 1
  , issueMilestone =
      Just
        Milestone
          { milestoneCreator =
              SimpleUser
                { simpleUserId = Id 48436
                , simpleUserLogin = N "coffeemug"
                , simpleUserAvatarUrl =
                    "https://avatars.githubusercontent.com/u/48436?v=3"
                , simpleUserUrl = "https://api.github.com/users/coffeemug"
                , simpleUserType = OwnerUser
                }
          , milestoneDueOn = Nothing
          , milestoneOpenIssues = 0
          , milestoneNumber = 71
          , milestoneClosedIssues = 113
          , milestoneDescription = Just ""
          , milestoneTitle = "1.14"
          , milestoneUrl =
              "https://api.github.com/repos/rethinkdb/rethinkdb/milestones/71"
          , milestoneCreatedAt = 2014 (-06) (-11) 22 : 31 : 05 UTC
          , milestoneState = "closed"
          }
  }